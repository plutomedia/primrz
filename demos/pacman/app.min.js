function getSourceCode(e){var t=pacman.toString(),n=e&&t||getSetting(CODE_KEY,t);if(n===t){var i=n.replace("\r\n","\n").split("\n");i.pop(),i.shift();for(var o=0;o<i.length;++o)i[o]=i[o].substring(2);n=i.join("\n")}return n.trim()}function wipeScene(){for(var e=subScene.children.length-1;e>=0;--e)subScene.remove(subScene.children[e])}function updateScript(){var e=editor.value;e!==lastScript&&(env.transition(function(){scriptUpdateTimeout=null,lastScript=e,e.indexOf("function update")>=0&&e.indexOf("return update")<0&&(e+="\nreturn update;"),console.log("----- loading new script -----"),scriptAnimate=null;try{var t=new Function("scene",e);wipeScene(),(scriptAnimate=t.call(env,subScene))&&scriptAnimate(0),console.log("----- script loaded -----"),scriptAnimate?env.quality===Primrose.Constants.Quality.NONE&&(env.quality=Primrose.Constants.Quality.MEDIUM):console.log("----- No update script provided -----")}catch(n){t=null,console.error(n),console.error(e)}},null,first),first=!1)}function pacman(){function e(e,t,n){var i=Math.floor((t.position.x+r/2+1)/o),s=Math.floor((t.position.z+a/2+1)/o),l=c[s],d=l&&0|l[i],u=t.velocity.clone().multiplyScalar(1.5*-e);d>0&&((n||t.isOnGround)&&t.position.add(u),n&&t.velocity.set(t.velocity.z,0,-t.velocity.x))}for(var t,n=Primrose.Random.int,i=Primrose.Graphics.ModelFactory.loadObject,o=3,r=30,a=30,s=[16711680,16776960,16711935,65535],c=["12222222221","10000000001","10222022201","10001000001","10101022201","10100010101","10222220101","10000000001","12222222221"],l=0;l<c.length;++l)for(var d=c[l],u=0;u<d.length;++u)!function(e,t,n){0!==e&&cylinder(.5,.5,o).colored(255).addTo(scene).rot(0,e*Math.PI/2,Math.PI/2).at(o*t-r/2,env.options.avatarHeight,o*n-a/2)}(0|d[u],u,l);return console.log("Here we go"),i("../shared_assets/models/ghost.obj").then(function(e){console.log("ghost",e),t=s.map(function(t,i){var o=e.clone(),r=o.children[0];return colored(r,t),scene.appendChild(o),o.position.set(3*i-4,0,-5),o.velocity=v3(0,0,0),o.velocity.x=n(-1,2),0===o.velocity.x&&0===o.velocity.z&&(o.velocity.z=n(-1,2)),o})}),function(n){t&&t.forEach(function(t){t.position.add(t.velocity.clone().multiplyScalar(n)),e(n,t,env.head)}),e(n,env.head,null)}}var GRASS="../shared_assets/images/grass.png",ROCK="../shared_assets/images/rock.png",SAND="../shared_assets/images/sand.png",WATER="../shared_assets/images/water.png",DECK="../shared_assets/images/deck.png",CODE_KEY="Pacman code",env=new Primrose.BrowserEnvironment({backgroundColor:0,skyTexture:DECK,groundTexture:DECK,font:"../shared_assets/fonts/helvetiker_regular.typeface.json",fullScreenButtonContainer:"#fullScreenButtonContainer"}),editor=null,modA=isMacOS?"metaKey":"ctrlKey",modB=isMacOS?"altKey":"shiftKey",cmdA=isMacOS?"CMD":"CTRL",cmdB=isMacOS?"OPT":"SHIFT",cmdPre=cmdA+"+"+cmdB,scriptUpdateTimeout,lastScript=null,scriptAnimate=null,subScene=hub();env.addEventListener("ready",function(){env.scene.add(subScene);var e=isMobile?512:1024,t=isMobile?10:20;editor=new Primrose.Controls.TextBox({id:"Editor",width:e,height:e,geometry:shell(1.5,25,25),fontSize:t,tokenizer:Primrose.Text.Grammars.JavaScript,value:getSourceCode(isInIFrame)}).addTo(env.vicinity).at(0,env.options.avatarHeight,0),Preloader.hide()},!1),window.addEventListener("beforeunload",function(e){},!1),window.addEventListener("unload",function(e){var t=editor&&editor.value;t&&t.length>0&&setSetting(CODE_KEY,t)},!1),env.addEventListener("update",function(){if(scriptUpdateTimeout||(scriptUpdateTimeout=setTimeout(updateScript,500)),scriptAnimate)if(env.quality===Primrose.Constants.Quality.NONE)scriptAnimate=null,wipeScene();else try{scriptAnimate.call(env,env.deltaTime)}catch(e){console.error(e),scriptAnimate=null}}),env.addEventListener("keydown",function(e){e[modA]&&e[modB]&&(e.keyCode===Primrose.Keys.E?editor.visible=!editor.visible:e.keyCode===Primrose.Keys.X&&(editor.value=getSourceCode(!0))),scriptUpdateTimeout&&(clearTimeout(scriptUpdateTimeout),scriptUpdateTimeout=null)});var first=!0;